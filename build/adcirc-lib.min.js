// https://github.com/atdyer/adcirc-lib Version 0.0.1. Copyright 2017 Tristan Dyer.
(function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r(e.adcirc=e.adcirc||{})})(this,function(e){"use strict";function r(e){function r(e,r,n){var o=n.slice(e,e+r);a.onload=t,a.readAsText(o)}function t(t){if(null!==t.target.error)throw f(t.target.error),t.target.error;var n=t.target.result;s+=n.length,s>=o?(u(n),l()):(u(n),c()?r(s,i,e):l())}var n=e,o=e.size,a=new FileReader,i=262144,s=0,u=function(){},c=function(){return!0},l=function(){},f=function(){},d=function(e){n=e,o=e.size};return d.read=function(){return r(s,i,e),d},d.read_block=function(e,r,t){var o=n.slice(e,r);a.onload=function(e){if(null!==e.target.error)throw f(e.target.error),e.target.error;t(e.target.result)},a.readAsText(o)},d.block_size=function(e){return arguments.length?(i=e,d):i},d.offset=function(e){return arguments.length?(s=e,d):s},d.block_callback=function(e){return arguments.length?("function"==typeof e&&(u=e),d):u},d.continue_callback=function(e){return arguments.length?("function"==typeof e&&(c=e),d):c},d.finished_callback=function(e){return arguments.length?("function"==typeof e&&(l=e),d):l},d.error_callback=function(e){return arguments.length?("function"==typeof e&&(f=e),d):f},d}function build_fort14_worker(){function e(){var e;if(K&&H.length)for(;void 0!==(e=H.shift());)e();if(X&&q.length)for(;void 0!==(e=q.shift());)e()}function t(){a("\n"),l(),e()}function n(e,r){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n,e[n]);return new r(t)}function o(e){_(e)}function a(e){R=0,e=I+e;for(var r,t;null!==(t=U.exec(e));)100*(L+t.index)/p>V&&(c(V),V+=Z),0==k?(B.agrid=L+t.index,m=t[0].trim()):1==k?(B.info_line=L+t.index,h=t[0].trim(),r=h.match(S),y=parseInt(r[0]),v=parseInt(r[1]),b=new Float32Array(3*v),x=new Uint32Array(3*y)):k>=2&&k<2+v?(2==k&&(B.nodes=L+t.index),i(t[0])):k>=2+v&&k<2+v+y?(K=!0,k==2+v&&(B.elements=L+t.index),s(t[0])):void 0===w?(X=!0,B.nope=L+t.index,r=t[0].match(S),w=parseInt(r[0])):void 0===A?(B.neta=L+t.index,r=t[0].match(S),A=parseInt(r[0])):C.length==w&&void 0===E?(B.nbou=L+t.index,r=t[0].match(S),E=parseInt(r[0])):C.length==w&&void 0===F?(B.nvel=L+t.index,r=t[0].match(S),F=parseInt(r[0])):Y==-1&&(C.length<w||D.length<E)?(r=t[0].match(S),Y=parseInt(r[0]),N=[]):N.length<Y&&(r=t[0].match(S),N.push(parseInt(r[0])),N.length==Y&&(C.length<w?C.push(N):D.length<E&&D.push(N),Y=-1,N=[])),R=U.lastIndex,k+=1;I=e.slice(R),L+=R}function i(e){var r=e.match(S),t=parseInt(r[0]),n=parseFloat(r[1]),o=parseFloat(r[2]),a=parseFloat(r[3]);n<T?T=n:n>z&&(z=n),o<P?P=o:o>M&&(M=o),a<O?O=a:a>W&&(W=a);var i=k-2;b[3*i]=n,b[3*i+1]=o,b[3*i+2]=a,j[t]=i}function s(e){var r=e.match(S),t=k-v-2,n=parseInt(r[0]);x[3*t]=parseInt(r[2]),x[3*t+1]=parseInt(r[3]),x[3*t+2]=parseInt(r[4]),G[n]=t}function u(){self.postMessage({type:"start"})}function c(e){self.postMessage({type:"progress",progress:e})}function l(){self.postMessage({type:"finish"})}function f(){var e=n(G,Uint32Array),r={type:"elements",element_array:x.buffer,element_map:e.buffer};self.postMessage(r,[r.element_array,r.element_map])}function d(){var e=n(j,Uint32Array),r={type:"nodes",node_array:b.buffer,node_map:e.buffer};self.postMessage(r,[r.node_array,r.node_map])}function _(e){self.postMessage({type:"error",error:e.message})}var g,p,m,h,v,y,b,x,w,A,E,F,R=0,L=0,k=0,B={},I="",U=/.*\r?\n/g,S=/\S+/g,T=1/0,z=-(1/0),P=1/0,M=-(1/0),O=1/0,W=-(1/0),j={},G={},C=[],D=[],Y=-1,N=[],K=!1,X=!1,H=[],q=[],Z=2,V=0+Z;self.addEventListener("message",function(n){switch(n=n.data,n.type){case"read":p=n.file.size,u(),g=r(n.file).block_callback(a).finished_callback(t).error_callback(o).read();break;case"get":"nodes"===n.what&&(H.push(d),e()),"elements"===n.what&&(q.push(f),e())}})}function t(){var e="";return e+=r.toString(),e+=build_fort14_worker.toString(),e+="build_fort14_worker();",U(e)}function n(e){for(var r=d3.map(),t=e.length/2,n=0;n<t;++n)r.set(e[2*n],e[2*n+1]);return r}function o(e){e=e||Object.create(null);var r={},t={};return e.on=function(t,n){return arguments.length?1==arguments.length?r[t]:(void 0===r[t]&&(r[t]=[]),r[t].indexOf(n)===-1&&r[t].push(n),e):e},e.once=function(r,n){return arguments.length?1==arguments.length?t[r]:(void 0===t[r]&&(t[r]=[]),t[r].indexOf(n)===-1&&t[r].push(n),e):e},e.off=function(n,o){var a,i=r[n],s=t[n];return void 0!==i&&(a=i.indexOf(o))!==-1&&i.splice(a,1),void 0!==s&&(a=s.indexOf(o))!==-1&&s.splice(a,1),e},e.dispatch=function(n){var o,a,i=r[n.type],s=t[n.type],u=[];if(void 0!==i){for(n.target=e,a=i.length,o=0;o<a;o++)u[o]=i[o];for(o=0;o<a;o++)u[o].call(e,n)}if(void 0!==s){for(n.target=e,a=s.length,o=0;o<a;o++)u[o]=s[o];for(o=0;o<a;o++)u[o].call(e,n);t[n.type]=[]}return e},e}function a(){var e,r,a=t(),i=o();return i.elements=function(r){return arguments.length?(e=r,i):e},i.nodes=function(e){return arguments.length?(r=e,i):r},i.read=function(e){a.postMessage({type:"read",file:e})},a.addEventListener("message",function(t){switch(t=t.data,t.type){case"start":i.dispatch({type:"start"});break;case"progress":i.dispatch({type:"progress",progress:t.progress});break;case"finish":i.dispatch({type:"finish"}),a.postMessage({type:"get",what:"nodes"}),a.postMessage({type:"get",what:"elements"});break;case"nodes":r={array:new Float32Array(t.node_array),map:n(new Uint32Array(t.node_map))},i.dispatch({type:"nodes",nodes:r}),r&&e&&i.dispatch({type:"ready"});break;case"elements":e={array:new Uint32Array(t.element_array),map:n(new Uint32Array(t.element_map))},i.dispatch({type:"elements",elements:e}),r&&e&&i.dispatch({type:"ready"})}}),i}function build_fortnd_worker(){function e(){var e=E.shift();e?(A=!0,e()):A=!1}function t(r){if(r<y){var t=R[r],n=F[t],o=r==y-1?p:F[R[r+1]];g.read_block(n,o,function(t){c(r,i(t)),e()})}}function n(e){p=e.size,l(),g=r(e).error_callback(s),g.read_block(0,1024,a)}function o(e){function r(e){e=s+e;for(var c,l=/.*\r?\n/g,_=0,p=1;null!==(c=l.exec(e));){var m=c[0].match(/\S+/g);if(m&&m.length>=2){if(a){var h=c[0].length*b;o=o-s.length+c.index+h,t+=1,n=R[t],i=!0,a=!1;break}parseFloat(m[1])==n?(a=!0,F[n]=o-s.length+c.index,f(t/y*100)):p=parseInt(m[0])}_=l.lastIndex}s="",i?i=!1:p<b/2?(o-=u,s=""):(o+=u,s=e.slice(_)),t<y?g.read_block(o,o+u,r):d()}var t=0,n=R[t],o=e,a=!1,i=!1,s="",u=65536;g.read_block(o,o+u,r)}function a(e){var r=/.*\r?\n/g,t=0,n=r.exec(e);if(null!==n&&(m=n[0],t+=n[0].length,null!==(n=r.exec(e)))){h=n[0],t+=n[0].length;var a=h.match(/\S+/g);y=parseInt(a[0]),b=parseInt(a[1]),w=parseInt(a[3]),x=parseFloat(a[2])/w;for(var i=0;i<y;++i)R.push((i+1)*w);u(),o(t)}}function i(e){for(var r,t,n,o=/.*\r?\n/g,a={array:new Float32Array(v*b),min:new Array(v).fill(1/0),max:new Array(v).fill(-(1/0))},i=0;null!==(r=o.exec(e));)if(0==i)t=r[0].match(/\S+/g),a.model_time=parseFloat(t[0]),a.timestep=parseInt(t[1]),i+=1;else{t=r[0].match(/\S+/g);for(var s=0;s<v;++s)n=parseFloat(t[1]),a.array[i++-1]=n,n!==-99999&&(n<a.min[s]?a.min[s]=n:n>a.max[s]&&(a.max[s]=n))}return a}function s(e){_(e)}function u(){self.postMessage({type:"info",file_size:p,num_datapoints:b,num_datasets:y,num_dimensions:v,model_timestep:x,model_timestep_interval:w})}function c(e,r){for(var t=[],n=0;n<v;++n)t.push([r.min[n],r.max[n]]);var o={type:"timestep",data_range:t,dimensions:v,index:e,model_time:r.model_time,model_timestep:r.timestep,array:r.array.buffer};self.postMessage(o,[o.array])}function l(){self.postMessage({type:"start"})}function f(e){self.postMessage({type:"progress",progress:e})}function d(){self.postMessage({type:"finish"})}function _(e){self.postMessage({type:"error",error:e.message})}var g,p,m,h,v,y,b,x,w,A=!1,E=[],F={},R=[];self.addEventListener("message",function(r){switch(r=r.data,r.type){case"n_dims":v=r.n_dims;break;case"read":n(r.file);break;case"timestep":E.push(function(){t(r.index)}),A||e()}})}function i(){var e="";return e+=r.toString(),e+=build_fortnd_worker.toString(),e+="build_fortnd_worker();",U(e)}function s(e){var r,t,n,o,a,i,s={};if(e.hasOwnProperty("data_range")&&e.hasOwnProperty("dimensions")&&e.hasOwnProperty("model_time")&&e.hasOwnProperty("model_timestep")&&e.hasOwnProperty("index")&&e.hasOwnProperty("array"))try{t=e.data_range,n=e.dimensions,o=e.index,a=e.model_time,i=e.model_timestep,r=new Float32Array(e.array)}catch(e){throw console.error("Error building timestep"),console.error(e.message),e}else console.error("Timestep is missing data"),console.error(e);return s.data=function(){return r},s.data_range=function(){return t},s.dimensions=function(){return n},s.index=function(e){return arguments.length?(o=e,s):o},s.model_time=function(e){return arguments.length?(a=e,s):a},s.model_timestep=function(e){return arguments.length?(i=e,s):i},s}function u(e){var r,t,n,a,u,c,l=e,f=i(),d=o();return d.timestep=function(e,r){return e>=0&&e<n&&("function"==typeof r&&d.once("timestep"+e,function(e){r(e)}),f.postMessage({type:"timestep",index:e})),d},d.read=function(e){return f.postMessage({type:"read",file:e}),d},f.addEventListener("message",function(e){switch(e=e.data,e.type){case"info":r=e.file_size,t=e.num_datapoints,n=e.num_datasets,a=e.num_dimensions,u=e.model_timestep,c=e.model_timestep_interval,d.dispatch({type:"info",file_size:r,num_datapoints:t,num_datasets:n,num_dimensions:a,model_timestep:u,model_timestep_interval:c});break;case"start":d.dispatch({type:"start"});break;case"progress":d.dispatch({type:"progress",progress:e.progress});break;case"finish":d.dispatch({type:"finish"}),d.dispatch({type:"ready"});break;case"timestep":var o=s(e);d.dispatch({type:"timestep",timestep:o}),d.dispatch({type:"timestep"+o.index(),timestep:o})}}),f.postMessage({type:"n_dims",n_dims:l}),d}function c(){return u(1)}function l(){return u(2)}function f(e){var r={};return{get:function(t){if(void 0!==r[t])return r[t];var n;switch(t){case"WEBGL_depth_texture":n=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":n=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":n=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":n=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;case"WEBGL_compressed_texture_etc1":n=e.getExtension("WEBGL_compressed_texture_etc1");break;default:n=e.getExtension(t)}return null===n&&console.warn("WebGL: "+t+" extension not supported."),r[t]=n,n}}}function d(e,r,t,n,o){var a=e.createShader(r);if(e.shaderSource(a,t),e.compileShader(a),e.getShaderParameter(a,e.COMPILE_STATUS)===!1){var i=e.getShaderInfoLog(a);return o||(o=console.error),o("Unable to compile shader"),o(i),void e.deleteShader(a)}return e.getShaderParameter(a,e.COMPILE_STATUS)===!1&&(n||(n=console.warn),n(e.getShaderInfoLog(a),_(t))),a}function _(e){for(var r=e.split("\n"),t=0;t<r.length;t++)r[t]=t+1+": "+r[t];return r.join("\n")}function g(e,r,t,n,o){var a=e.createProgram(),i=d(e,e.VERTEX_SHADER,r,n,o),s=d(e,e.FRAGMENT_SHADER,t,n,o);if(a&&i&&s)return e.attachShader(a,i),e.attachShader(a,s),e.linkProgram(a),e.getProgramParameter(a,e.LINK_STATUS)===!1&&(o||(o=console.error),o(e.getProgramInfoLog(a))),e.deleteShader(i),e.deleteShader(s),a}function p(e){var r=e,t=g(r,m(),h()),n=d3.color("white"),o=d3.color("black"),a=.3,i=1;r.useProgram(t);var s=d3.map({vertex_normal:r.getAttribLocation(t,"vertex_normal"),vertex_position:r.getAttribLocation(t,"vertex_position")}),u=d3.map({face_color:r.getUniformLocation(t,"face_color"),projection_matrix:r.getUniformLocation(t,"projection_matrix"),wire_alpha:r.getUniformLocation(t,"wire_alpha"),wire_color:r.getUniformLocation(t,"wire_color"),wire_width:r.getUniformLocation(t,"wire_width")});return t.attribute=function(e){return s.get(e)},t.attributes=function(e){return arguments.length?(s.each(e),t):s.keys()},t.face_color=function(e){return arguments.length?(n=e,r.useProgram(t),r.uniform3fv(t.uniform("face_color"),[e.r/255,e.g/255,e.b/255]),t):n},t.set_projection=function(e){return r.useProgram(t),r.uniformMatrix4fv(t.uniform("projection_matrix"),!1,e),t},t.wire_alpha=function(e){return arguments.length?(a=e,r.useProgram(t),r.uniform1f(t.uniform("wire_alpha"),e),t):a},t.wire_color=function(e){return arguments.length?(o=e,r.useProgram(t),r.uniform3fv(t.uniform("wire_color"),[e.r/255,e.g/255,e.b/255]),t):o},t.wire_width=function(e){return arguments.length?(i=e,r.useProgram(t),r.uniform1f(t.uniform("wire_width"),e),t):i},t.uniform=function(e){return u.get(e)},t.uniforms=function(){return u.keys()},t.use=function(){return r.useProgram(t),t},t.face_color(t.face_color()).wire_alpha(t.wire_alpha()).wire_color(t.wire_color()).wire_width(t.wire_width())}function m(){return["attribute vec3 vertex_position;","attribute vec3 vertex_normal;","uniform mat4 projection_matrix;","varying vec3 _vertex_normal;","void main( void ) {","   gl_Position = projection_matrix * vec4( vertex_position, 1.0 );","   _vertex_normal = vertex_normal;","}"].join("\n")}function h(){return["#extension GL_OES_standard_derivatives : enable","precision highp float;","varying vec3 _vertex_normal;","uniform vec3 face_color;","uniform vec3 wire_color;","uniform float wire_alpha;","uniform float wire_width;","float edgeFactorTri() {","   vec3 d = fwidth( _vertex_normal.xyz );","   vec3 a3 = smoothstep( vec3( 0.0 ), d * wire_width, _vertex_normal.xyz );","   return min( min( a3.x, a3.y ), a3.z );","}","void main() {","   vec4 wire = mix( vec4(face_color, 1.0), vec4(wire_color, 1.0), wire_alpha);","   gl_FragColor = mix( wire, vec4(face_color, 1.0), edgeFactorTri() );","}"].join("\n")}function v(e,r,t,n){for(var o=e,a=g(o,y(r),b()),i=[],s=[],u=d3.color("black"),c=.3,l=1,t=t||0,n=n||1,f=0;f<r;++f)s.push(t+(n-t)*f/(r-1)),i.push(d3.color(d3.schemeCategory20c[f%r]));o.useProgram(a);var d=d3.map({vertex_normal:o.getAttribLocation(a,"vertex_normal"),vertex_position:o.getAttribLocation(a,"vertex_position"),vertex_value:o.getAttribLocation(a,"vertex_value")}),_=d3.map({gradient_colors:o.getUniformLocation(a,"gradient_colors"),gradient_stops:o.getUniformLocation(a,"gradient_stops"),projection_matrix:o.getUniformLocation(a,"projection_matrix"),wire_alpha:o.getUniformLocation(a,"wire_alpha"),wire_color:o.getUniformLocation(a,"wire_color"),wire_width:o.getUniformLocation(a,"wire_width")});return a.attribute=function(e){return d.get(e)},a.attributes=function(e){return arguments.length?(d.each(e),a):d.keys()},a.gradient_colors=function(e){if(!arguments.length)return i;i=e;var r=i.map(function(e){return[e.r/255,e.g/255,e.b/255]}).reduce(function(e,r){return e.concat(r)},[]);return o.useProgram(a),o.uniform3fv(a.uniform("gradient_colors"),r),a},a.gradient_stops=function(e){return arguments.length?(s=e,o.useProgram(a),o.uniform1fv(a.uniform("gradient_stops"),s),a):s},a.set_projection=function(e){return o.useProgram(a),o.uniformMatrix4fv(a.uniform("projection_matrix"),!1,e),a},a.wire_alpha=function(e){return arguments.length?(c=e,o.useProgram(a),o.uniform1f(a.uniform("wire_alpha"),e),a):c},a.wire_color=function(e){return arguments.length?(u=e,o.useProgram(a),o.uniform3fv(a.uniform("wire_color"),[e.r/255,e.g/255,e.b/255]),a):u},a.wire_width=function(e){return arguments.length?(l=e,o.useProgram(a),o.uniform1f(a.uniform("wire_width"),e),a):l},a.uniform=function(e){return _.get(e)},a.uniforms=function(){return _.keys()},a.use=function(){return o.useProgram(a),a},a.gradient_colors(a.gradient_colors()).gradient_stops(a.gradient_stops()).wire_alpha(a.wire_alpha()).wire_color(a.wire_color()).wire_width(a.wire_width())}function y(e){for(var r=["attribute vec2 vertex_position;","attribute vec3 vertex_normal;","attribute float vertex_value;","uniform mat4 projection_matrix;","uniform float gradient_stops["+e+"];","uniform vec3 gradient_colors["+e+"];","varying vec3 _vertex_normal;","varying vec3 _vertex_color;","void main() {","  gl_Position = projection_matrix * vec4( vertex_position, vertex_value, 1.0 );","  _vertex_normal = vertex_normal;","  _vertex_color = gradient_colors[0];","  float t;"],t=1;t<e;++t)r.push("  t = clamp((vertex_value - gradient_stops["+(t-1)+"]) / (gradient_stops["+t+"]-gradient_stops["+(t-1)+"]), 0.0, 1.0);"),r.push("  _vertex_color = mix( _vertex_color, gradient_colors["+t+"], t*t*(3.0-2.0*t));");return r.push("}"),r.join("\n")}function b(){return["#extension GL_OES_standard_derivatives : enable","precision mediump float;","varying vec3 _vertex_normal;","varying vec3 _vertex_color;","uniform vec3 wire_color;","uniform float wire_alpha;","uniform float wire_width;","float edgeFactorTri() {","   vec3 d = fwidth( _vertex_normal.xyz );","   vec3 a3 = smoothstep( vec3( 0.0 ), d * wire_width, _vertex_normal.xyz );","   return min( min( a3.x, a3.y ), a3.z );","}","void main() {","   vec4 wire = mix( vec4(_vertex_color, 1.0), vec4(wire_color, 1.0), wire_alpha);","   gl_FragColor = mix( wire, vec4(_vertex_color, 1.0), edgeFactorTri() );","}"].join("\n")}function x(){function e(){for(var e=0;e<16;++e)t[e]=n[e];return t}function r(){for(var e=0;e<16;++e)n[e]=t[e];return n}var t=new Float32Array(16).fill(0),n=new Float32Array(16);return t[0]=t[5]=t[10]=t[15]=1,t.identity=function(){return t.fill(0),t[0]=t[5]=t[10]=t[15]=1,t},t.ortho=function(e,r,n,o,a,i){return t[0]=2/(r-e),t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2/(o-n),t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=-1/(i-a),t[11]=0,t[12]=(r+e)/(e-r),t[13]=(o+n)/(n-o),t[14]=-a/(a-i),t[15]=1,t},t.scale=function(r,o,a){return n[0]=r*t[0],n[1]=r*t[1],n[2]=r*t[2],n[3]=r*t[3],n[4]=o*t[4],n[5]=o*t[5],n[6]=o*t[6],n[7]=o*t[7],n[8]=a*t[8],n[9]=a*t[9],n[10]=a*t[10],n[11]=a*t[11],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],e(),t},t.translate=function(o,a,i){return r(),n[12]=t[0]*o+t[4]*a+t[8]*i+t[12],n[13]=t[1]*o+t[5]*a+t[9]*i+t[13],n[14]=t[2]*o+t[6]*a+t[10]*i+t[14],n[15]=t[3]*o+t[7]*a+t[11]*i+t[15],e()},t}function w(e,r){function t(){}function n(e){if(e==s){for(var r=new Float32Array(3*c),t=a.nodal_value(e),n=a.elements(),o=a.nodes(),u=0;u<3*c;++u){var l=n.array[u],d=o.map.get(l);r[u]=t[d]}var p=_.get("vertex_value");f.bindBuffer(f.ARRAY_BUFFER,p.buffer),f.bufferSubData(f.ARRAY_BUFFER,0,r),g.forEach(function(r){r(e)})}if(e==i){for(var r=new Float32Array(3*c),t=a.elemental_value(e),u=0;u<c;++u){var e=t[u];r[3*u]=e,r[3*u+1]=e,r[3*u+2]=e}var p=_.get("vertex_value");f.bindBuffer(f.ARRAY_BUFFER,p.buffer),f.bufferSubData(f.ARRAY_BUFFER,0,r),g.forEach(function(r){r(e)})}}function o(){if(!d){var e=new Float32Array(9*c);e.fill(0);for(var r=0;r<c;++r)e[9*r]=1,e[9*r+4]=1,e[9*r+8]=1;return e}console.error("You shouldn't be making vertex normals for indexed arrays")}var a,i,s,u,c,l,f=e,d=r||!1,_=d3.map(),g=[];return t.bind_buffer=function(e){var r=_.get(e);return f.bindBuffer(f.ARRAY_BUFFER,r.buffer),r},t.bind_element_array=function(){var e=_.get("element_array");return f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,e.buffer),t},t.bounding_box=function(){return u},t.elemental_value=function(e){return i=e,t},t.indexed=function(){return d},t.mesh=function(e){if(!arguments.length)return a;a=e,u=a.bounding_box();var r=a.nodes(),o=a.elements();if(c=o.array.length/3,d){l=r.array.length/3;for(var i=new Float32Array(2*l/3),s=new Float32Array(l/3),g=new Uint32Array(c),p=0;p<c;++p){var m=o.array[p],h=r.map.get(m);i[h]=r.array[h],i[h+1]=r.array[h+1],s[h]=r.array[h+2],g[p]=h}var v=f.createBuffer();f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,v),f.bufferData(f.ELEMENT_ARRAY_BUFFER,g,f.STATIC_DRAW),_.set("element_array",{buffer:v})}else{l=3*c;for(var i=new Float32Array(6*c),s=new Float32Array(3*c),p=0;p<3*c;++p){var m=o.array[p],h=r.map.get(m);i[2*p]=r.array[3*h],i[2*p+1]=r.array[3*h+1],s[p]=r.array[3*h+2]}}var y=f.createBuffer();f.bindBuffer(f.ARRAY_BUFFER,y),f.bufferData(f.ARRAY_BUFFER,i,f.STATIC_DRAW);var b=f.createBuffer();return f.bindBuffer(f.ARRAY_BUFFER,b),f.bufferData(f.ARRAY_BUFFER,s,f.DYNAMIC_DRAW),_.set("vertex_position",{buffer:y,size:2,type:f.FLOAT,normalized:!1,stride:0,offset:0}),_.set("vertex_value",{buffer:b,size:1,type:f.FLOAT,normalize:!1,stride:0,offset:0}),a.subscribe(n),t},t.nodal_value=function(e){return s=e,t},t.num_triangles=function(){return c},t.num_vertices=function(){return l},t.request_vertex_attribute=function(e){switch(e){case"vertex_normal":var r=o(),t=f.createBuffer();f.bindBuffer(f.ARRAY_BUFFER,t),f.bufferData(f.ARRAY_BUFFER,r,f.STATIC_DRAW),_.set("vertex_normal",{buffer:t,size:3,type:f.FLOAT,normalized:!1,stride:0,offset:0});break;case"vertex_position":case"vertex_value":break;default:console.warn(e+" attribute not supported")}},t.subscribe=function(e){return arguments.length?(g.push(e),t):(g=[],t)},t}function A(e){function r(e,a){return n=e,o=a,o.attributes(function(e,r){n.request_vertex_attribute(r)}),n.subscribe(t),r}function t(){i.forEach(function(e){e.apply(e,arguments)})}var n,o,a=e,i=[];return r.bounding_box=function(){return n?n.bounding_box():[[null,null,null],[null,null,null]]},r.geometry=function(){return n},r.render=function(){return n&&o&&(o.use(),o.attributes(function(e,r){var t=n.bind_buffer(r);a.vertexAttribPointer(e,t.size,t.type,t.normalized,t.stride,t.offset),a.enableVertexAttribArray(e)}),n.indexed()?(n.bind_element_array(),a.drawElements(a.TRIANGLES,3*n.num_triangles(),a.UNSIGNED_INT,0)):a.drawArrays(a.TRIANGLES,0,3*n.num_triangles())),r},r.shader=function(){return o},r.subscribe=function(e){return arguments.length?(i.push(e),r):(i=[],r)},r}function E(){function e(t){if(u=t,c=d3.select(u),!F(t))return void(d&&d("WebGL not supported"));var n={alpha:!1,antialias:!1,premultipliedAlpha:!1,stencil:!0};return null===(i=u.getContext("webgl",n)||u.getContext("experimental-webgl",n))?void(d&&d("Error creating WebGL context")):(l&&u.addEventListener("webglcontextlost",l,!1),s=f(i),s.get("ANGLE_instanced_arrays"),s.get("OES_element_index_uint"),s.get("OES_standard_derivatives"),e.clear_color(e.clear_color()),r(),c.call(h),e)}function r(){(n()||_)&&(_=!1,t()),requestAnimationFrame(r)}function t(){i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT);for(var e=0;e<E.length;++e)E[e].render()}function n(){return(u.clientWidth!=g||u.clientHeight!=p)&&(g=u.clientWidth,p=u.clientHeight,u.width=g*m,u.height=p*m,i.viewport(0,0,g,p),o(),!0)}function o(e,r,t){if(!arguments.length){var n=d3.zoomTransform(u);return o(n.k,n.x,n.y)}y.ortho(0,g,p,0,-1e4,1e4).translate(r,t,0).scale(e,-e,1).translate(0,-p,0);for(var a=0;a<E.length;++a)E[a].shader().set_projection(y)}function a(){var r=d3.event.transform;o(r.k,r.x,r.y),e.render()}var i,s,u,c,l,d,_=!0,g=300,p=150,m=1,h=d3.zoom().on("zoom",a),y=x(),b=d3.color("#666666"),E=[];return e.add_mesh=function(r){var t=w(i).mesh(r),n=v(i,10,t.bounding_box()[0][2],t.bounding_box()[1][2]),a=A(i);return E.push(a(t,n)),o(),e.render()},e.add_view=function(r){return r.subscribe(e.render),E.push(r),o(),e.render()},e.clear_color=function(r){return arguments.length?(1==arguments.length&&(b=r),3==arguments.length&&(b=d3.rgb(arguments[0],arguments[1],arguments[2])),4==arguments.length&&(b=d3.rgb(arguments[0],arguments[1],arguments[2],arguments[3])),i&&b&&(i.clearColor(b.r/255,b.g/255,b.b/255,b.opacity),e.render()),e):b},e.gl_context=function(r){return arguments.length?(i=r,e):i},e.on_context_lost=function(r){return arguments.length?("function"==typeof r&&(l=r),e):l},e.on_error=function(r){return arguments.length?("function"==typeof r&&(d=r),e):d},e.render=function(){return _=!0,e},e.zoom_to=function(r){if(!arguments.length)return e;var t=r.bounding_box(),n=0,o=t[1][0]-t[0][0],a=t[1][1]-t[0][1],i=(t[0][0]+t[1][0])/2,s=p-(t[0][1]+t[1][1])/2,u=.9/Math.max(o/g,a/p),l=[g/2-u*i,p/2-u*s];2==arguments.length&&(n=arguments[1]),c.transition().duration(n).call(h.transform,d3.zoomIdentity.translate(l[0],l[1]).scale(u))},e}function F(e){return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}function R(){function e(){}var r,t={array:[],map:d3.map()},n={array:[],map:d3.map()},o=d3.map(),a=d3.map(),i=[];return e.bounding_box=function(){return r},e.elemental_value=function(e,r){if(1==arguments.length)return a.get(e);2==arguments.length&&a.set(e,r),i.forEach(function(r){r(e)})},e.elements=function(r){return arguments.length?(r.array&&r.map&&(n=r),e):n},e.element_array=function(r){return arguments.length?(n.array=r,e):n.array},e.element_index=function(e){return n.map.get(e)},e.element_map=function(r){return arguments.length?(n.map=r,e):n.map},e.nodal_value=function(r,t){return 1==arguments.length?o.get(r):(2==arguments.length&&o.set(r,t),i.forEach(function(e){e(r)}),e)},e.nodes=function(n){return arguments.length?(n.array&&n.map&&(t=n,r=L(t.array)),e):t},e.node_array=function(r){return arguments.length?(t.array=r,L(e.node_array()),e):t.array},e.node_index=function(e){return t.map.get(e)},e.node_map=function(r){return arguments.length?(t.map=r,e):t.map},e.num_elements=function(){return n.array.length/3},e.num_nodes=function(){return t.array.length/3},e.subscribe=function(e){i.push(e)},e}function L(e){for(var r=e.length/3,t=1/0,n=-(1/0),o=1/0,a=-(1/0),i=1/0,s=-(1/0),u=0;u<r;++u)e[3*u]<t?t=e[3*u]:e[3*u]>n&&(n=e[3*u]),e[3*u+1]<o?o=e[3*u+1]:e[3*u+1]>a&&(a=e[3*u+1]),e[3*u+2]<i?i=e[3*u+2]:e[3*u+2]>s&&(s=e[3*u+2]);return[[t,o,i],[n,a,s]]}function k(){function e(e){return e%u}function r(r){_[e(r)]=!1,--m}function t(){return void 0===u||void 0===s?(console.error("Cache sizes not defined"),!1):!!(void 0!==a&&void 0!==i||l)||(console.error("A getter must be defined if cache is not bounded by other caches"),!1)}function n(r){_[e(r)]=!0,++m,p.is_full()&&p.dispatch({type:"ready"})}var a,i,s,u,c,l,f,d,_,g,p=o(),m=0;return p.cache_left=function(e){return arguments.length?(a=e,p):a},p.cache_right=function(e){return arguments.length?(i=e,p):i},p.contains=function(e){return e>=g&&e<g+u},p.get=function(r){if(!t())return void console.error("Cache has not been properly initialized");if(p.valid(r))return d[e(r)];if(r<0||r>=s)return void console.error(r+" is outside allowable range");if(r!=g-1){if(r!=g+u)console.error("Jumps not yet supported. Coming soon...");else if(p.shift_right())return d[e(r)]}else if(p.shift_left())return d[e(r)]},p.getter=function(e){return arguments.length?("function"==typeof e?(c=e,l=!0):console.error("Getter must be a function"),p):c},p.is_full=function(){return m==u},p.max_size=function(e){return arguments.length?(s=e,p):s},p.print=function(){console.log(d)},p.range=function(e){if(!arguments.length)return[g,g+u];if(!t())return void console.error("Cache not yet initialized. Set size and accessors before range");if(e[1]-e[0]!==u)return void console.error("Invalid range for cache of size "+u);g=e[0];for(var r=g;r<g+u;++r)a&&a.contains(r)?p.set(r,a.get(r)):i&&i.contains(r)?p.set(r,i.get(r)):c(r,p.set);return p},p.set=function(r,t){p.contains(r)?(d[e(r)]=f(e(r),t),n(r)):console.warn("Dataset "+r+" does not fall into the cache range")},p.size=function(e){return arguments.length?(u=e,d&&console.warn("Warning: Resizing cache, all data will be lost"),d=new Array(u),_=new Array(u).fill(!1),m=0,p):u},p.transform=function(e){return arguments.length?("function"==typeof e&&(f=e),p):f},p.shift_left=function(){var e,t=g-1;return!(t<0)&&(a&&(g==a.range()[1]?e=a.take_right():a.valid(t)&&(e=a.get(t))),i&&(g+u==i.range()[0]?a&&i.range()[0]!==a.range()[1]&&i.shift_left():i.valid(t)&&(e=i.get(t))),!(void 0===e&&!l)&&(g=t,r(g),void 0!==e?p.set(t,e):c(t,p.set),!0))},p.shift_right=function(){var e,t=g+u;return!(t>=s)&&(i&&(t==i.range()[0]?e=i.take_left():i.valid(t)&&(e=i.get(t))),a&&(g==a.range()[1]?i&&i.range()[0]!==a.range()[1]&&a.shift_right():a.valid(t)&&(e=a.get(t))),!(void 0===e&&!l)&&(g+=1,r(t),i?p.set(t,e):c(t,p.set),!0))},p.take_left=function(){var r,t=g;return _[e(t)]&&(r=d[e(t)],p.shift_right()),r},p.take_right=function(){var r,t=g+u-1;return _[e(t)]&&(r=d[e(t)],p.shift_left()),r},p.valid=function(r){return p.contains(r)&&_[e(r)]},f=function(e,r){return r},c=function(){console.error("A getter has not been defined for this cache.")},p}function B(){function e(r){return u=r.style("position","relative").style("width","100%").style("margin-top","4px").style("margin-bottom","4px").style("user-select","none"),c=u.selectAll("div").data(["slider_bar"]),c.exit().remove(),c=c.enter().append("div").merge(c),c.style("position","relative").style("left",0).style("width","1px").style("background-clip","content-box").style("margin","-4px").style("border-width","4px").style("border-style","solid").style("user-select","none"),l=u.node().getBoundingClientRect().width,E.domain([0,l]),u.on("mousedown",t).on("wheel",i),e.arrows(f),e.bar(d),e.color(_),e.domain([0,100]),e.draggable(v),e.height(p),e.jumpable(y),e}function r(e){var r=A.domain();return e<r[0]?r[0]:e>r[1]?r[1]:e}function t(){if(y){var e=d3.mouse(this)[0];e<0&&(e=0),e>l&&(e=l);s(E(e))&&n()}}function n(){e.dispatch({type:"value",value:g})}function a(){if(v){var e=d3.event.x;e<0&&(e=0),e>l&&(e=l);s(E(e))&&n()}}function i(){if(v){var r=d3.event.shiftKey?10*x:x,t=d3.event.deltaX<0||d3.event.deltaY<0?1:-1;s(e.current()+r*t)&&n()}}function s(e){return(e=b?r(e):w(e))!==g&&(g=y?e:e>g?g+x:g-x,c&&c.style("left",A(g)+"%"),!0)}var u,c,l,f="both",d="dimgray",_="lightgray",g=0,p=20,m=d3.drag().on("drag",a),h=d3.drag().on("start",t).on("drag",a),v=!0,y=!0,b=!1,x=1,w=d3.scaleQuantize(),A=d3.scaleLinear().range([0,100]).clamp(!0),E=d3.scaleLinear();return e.arrows=function(r){if(!arguments.length)return f;if(("top"==r||"bottom"==r||"both"==r||"none"==r)&&(f=r,c))switch(f){case"both":c.style("border-color",d+" transparent "+d+" transparent");break;case"top":c.style("border-color",d+" transparent transparent transparent");break;case"bottom":c.style("border-color","transparent transparent "+d+" transparent");break;default:c.style("border-color","transparent transparent transparent transparent")}return e},e.bar=function(r){return arguments.length?(d=r,c&&(c.style("background-color",d),e.arrows(f)),e):d},e.color=function(r){return arguments.length?(_=r,u&&u.style("background-color",_),e):_},e.continuous=function(r){return arguments.length?(b=!!r,e):b},e.current=function(r){return arguments.length?(s(r),e):g},e.domain=function(r){if(!arguments.length)return A.domain();var t=[];x=2==arguments.length?arguments[1]:1;for(var n=r[0];n<=r[1];n+=x)t.push(n);return w.domain(r).range(t),A.domain(r),E.range(r),e},e.draggable=function(r){return arguments.length?(v=!!r,c&&(v?c.style("cursor","pointer").call(m):c.style("cursor",null).on(".drag",null)),e):v},e.height=function(r){return arguments.length?(p=r,u&&u.style("min-height",p+"px"),c&&c.style("min-height",p+"px"),e):p},e.jumpable=function(r){return arguments.length?(y=!!r,u&&(y?u.style("cursor","pointer").call(h):u.style("cursor",null).on(".drag",null)),e):y},o(e)}function I(e){function r(e){return e.append("div").style("display","flex").style("flex-direction","column")}var t=Object.create(null);return e.selectAll(".slider").each(function(){var e=d3.select(this),n=e.attr("id");if(!n||t[n])return void console.error("All UI components must have a unique ID");t[n]=B()(r(e))}),t}var U=function(e){var r=URL.createObjectURL(new Blob([e],{type:"application/javascript"})),t=new Worker(r);return URL.revokeObjectURL(r),t};e.fort14=a,e.fort63=c,e.fort64=l,e.gl_renderer=E,e.mesh=R,e.geometry=w,e.view=A,e.basic_shader=p,e.gradient_shader=v,e.cache=k,e.dispatcher=o,e.slider=B,e.ui=I,Object.defineProperty(e,"__esModule",{value:!0})});