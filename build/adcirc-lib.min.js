// https://github.com/atdyer/adcirc-lib Version 0.0.1. Copyright 2017 Tristan Dyer.
(function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r(e.adcirc=e.adcirc||{})})(this,function(e){"use strict";function r(e){function r(e,r,n){var o=n.slice(e,e+r);i.onload=t,i.readAsText(o)}function t(t){if(null!==t.target.error)throw l(t.target.error),t.target.error;var n=t.target.result;u+=n.length,u>=o?(c(n),s()):(c(n),f()?r(u,a,e):s())}var n=e,o=e.size,i=new FileReader,a=262144,u=0,c=function(){},f=function(){return!0},s=function(){},l=function(){},_=function(e){n=e,o=e.size};return _.read=function(){return r(u,a,e),_},_.read_block=function(e,r,t){var o=n.slice(e,r);i.onload=function(e){if(null!==e.target.error)throw l(e.target.error),e.target.error;t(e.target.result)},i.readAsText(o)},_.block_size=function(e){return arguments.length?(a=e,_):a},_.offset=function(e){return arguments.length?(u=e,_):u},_.block_callback=function(e){return arguments.length?("function"==typeof e&&(c=e),_):c},_.continue_callback=function(e){return arguments.length?("function"==typeof e&&(f=e),_):f},_.finished_callback=function(e){return arguments.length?("function"==typeof e&&(s=e),_):s},_.error_callback=function(e){return arguments.length?("function"==typeof e&&(l=e),_):l},_}function build_fort14_worker(){function e(){var e;if(H&&X.length)for(;void 0!==(e=X.shift());)e();if(K&&q.length)for(;void 0!==(e=q.shift());)e()}function t(){i("\n"),s(),e()}function n(e,r){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n,e[n]);return new r(t)}function o(e){g(e)}function i(e){R=0,e=I+e;for(var r,t;null!==(t=T.exec(e));)100*(F+t.index)/h>V&&(f(V),V+=Z),0==k?(B.agrid=F+t.index,p=t[0].trim()):1==k?(B.info_line=F+t.index,m=t[0].trim(),r=m.match(U),x=parseInt(r[0]),v=parseInt(r[1]),b=new Float32Array(3*v),y=new Uint32Array(3*x)):k>=2&&k<2+v?(2==k&&(B.nodes=F+t.index),a(t[0])):k>=2+v&&k<2+v+x?(H=!0,k==2+v&&(B.elements=F+t.index),u(t[0])):void 0===w?(K=!0,B.nope=F+t.index,r=t[0].match(U),w=parseInt(r[0])):void 0===E?(B.neta=F+t.index,r=t[0].match(U),E=parseInt(r[0])):O.length==w&&void 0===A?(B.nbou=F+t.index,r=t[0].match(U),A=parseInt(r[0])):O.length==w&&void 0===L?(B.nvel=F+t.index,r=t[0].match(U),L=parseInt(r[0])):Y==-1&&(O.length<w||D.length<A)?(r=t[0].match(U),Y=parseInt(r[0]),N=[]):N.length<Y&&(r=t[0].match(U),N.push(parseInt(r[0])),N.length==Y&&(O.length<w?O.push(N):D.length<A&&D.push(N),Y=-1,N=[])),R=T.lastIndex,k+=1;I=e.slice(R),F+=R}function a(e){var r=e.match(U),t=parseInt(r[0]),n=parseFloat(r[1]),o=parseFloat(r[2]),i=parseFloat(r[3]);n<S?S=n:n>z&&(z=n),o<M?M=o:o>P&&(P=o),i<W?W=i:i>G&&(G=i);var a=k-2;b[3*a]=n,b[3*a+1]=o,b[3*a+2]=i,j[t]=a}function u(e){var r=e.match(U),t=k-v-2,n=parseInt(r[0]);y[3*t]=parseInt(r[2]),y[3*t+1]=parseInt(r[3]),y[3*t+2]=parseInt(r[4]),C[n]=t}function c(){self.postMessage({type:"start"})}function f(e){self.postMessage({type:"progress",progress:e})}function s(){self.postMessage({type:"finish"})}function l(){var e=n(C,Uint32Array),r={type:"elements",element_array:y.buffer,element_map:e.buffer};self.postMessage(r,[r.element_array,r.element_map])}function _(){var e=n(j,Uint32Array),r={type:"nodes",node_array:b.buffer,node_map:e.buffer};self.postMessage(r,[r.node_array,r.node_map])}function g(e){self.postMessage({type:"error",error:e.message})}var d,h,p,m,v,x,b,y,w,E,A,L,R=0,F=0,k=0,B={},I="",T=/.*\r?\n/g,U=/\S+/g,S=1/0,z=-(1/0),M=1/0,P=-(1/0),W=1/0,G=-(1/0),j={},C={},O=[],D=[],Y=-1,N=[],H=!1,K=!1,X=[],q=[],Z=2,V=0+Z;self.addEventListener("message",function(n){switch(n=n.data,n.type){case"read":h=n.file.size,c(),d=r(n.file).block_callback(i).finished_callback(t).error_callback(o).read();break;case"get":"nodes"===n.what&&(X.push(_),e()),"elements"===n.what&&(q.push(l),e())}})}function t(){var e="";return e+=r.toString(),e+=build_fort14_worker.toString(),e+="build_fort14_worker();",F(e)}function n(e){for(var r=d3.map(),t=e.length/2,n=0;n<t;++n)r.set(e[2*n],e[2*n+1]);return r}function o(){var e,r,o=t(),i=function(){},a=[],u=[],c=[],f=[],s=[],l=[],_=[],g=[],d=[],h=[];return i.elements=function(r){return arguments.length?"function"==typeof arguments[0]?(2==arguments.length&&arguments[1]===!0&&d.push(arguments[0]),e?r(e):((arguments.length<2||arguments[1]!==!0)&&f.push(arguments[0]),o.postMessage({type:"get",what:"elements"}),i)):(e=r,i):e},i.nodes=function(e){return arguments.length?"function"==typeof arguments[0]?(2==arguments.length&&arguments[1]===!0&&h.push(arguments[0]),r?e(r):((arguments.length<2||arguments[1]!==!0)&&s.push(arguments[0]),o.postMessage({type:"get",what:"nodes"}),i)):(r=e,i):r},i.on_finish=function(e){return arguments.length?("function"==typeof arguments[0]&&(1==arguments.length&&c.push(arguments[0]),2==arguments.length&&arguments[1]===!0&&g.push(arguments[0])),i):c},i.on_progress=function(e){return arguments.length?("function"==typeof arguments[0]&&(1==arguments.length&&u.push(arguments[0]),2==arguments.length&&arguments[1]===!0&&_.push(arguments[0])),i):u},i.on_start=function(e){return arguments.length?("function"==typeof arguments[0]&&(1==arguments.length&&a.push(arguments[0]),2==arguments.length&&arguments[1]===!0&&l.push(arguments[0])),i):a},i.read=function(e){o.postMessage({type:"read",file:e})},o.addEventListener("message",function(t){switch(t=t.data,t.type){case"start":for(var o=0;o<l.length;++o)l[o]();for(var i;void 0!==(i=a.shift());)i();break;case"progress":for(var o=0;o<_.length;++o)_[o](t.progress);for(var i;void 0!==(i=u.shift());)i(t.progress);break;case"finish":for(var o=0;o<g.length;++o)g[o]();for(var i;void 0!==(i=c.shift());)i();break;case"nodes":r={array:new Float32Array(t.node_array),map:n(new Uint32Array(t.node_map))};for(var o=0;o<h.length;++o)h[o](r);for(var i;void 0!==(i=s.shift());)i(r);break;case"elements":e={array:new Uint32Array(t.element_array),map:n(new Uint32Array(t.element_map))};for(var o=0;o<d.length;++o)d[o](r);for(var i;void 0!==(i=f.shift());)i(e)}}),i}function build_fortnd_worker(){function e(e){if(e<h){var r=b[e],t=x[r],n=e==h-1?l:x[b[e+1]],o=n-t;console.log(o+" bytes");var i=performance.now();s.read_block(t,n,function(e){var r=performance.now(),t=e.length;console.log("Read "+t+" bytes in "+(r-i)+" milliseconds")})}}function t(e){l=e.size,a(),s=r(e).error_callback(i),s.read_block(0,1024,o)}function n(){function e(i){var a,f=/.*\r?\n/g;if(r===!1)for(;null!==(a=f.exec(i));){var l=a[0].match(/\S+/g);if(l.length>=2){var _=parseInt(l[1]);_==n&&(r=!0,x[n]=o+a.index,o+=f.lastIndex,t+=1,u(t/h*100),t<h?(n=b[t],s.read_block(o,o+1024,e)):c())}}else a=f.exec(i),o+=p*a[0].length,r=!1,s.read_block(o,o+1024,e)}var r=!1,t=0,n=b[t],o=0;s.read_block(o,o+1024,e)}function o(e){var r=/.*\r?\n/g,t=r.exec(e);if(null!==t&&(_=t[0],null!==(t=r.exec(e)))){g=t[0];var o=g.match(/\S+/g);h=parseInt(o[0]),p=parseInt(o[1]),v=parseInt(o[3]),m=parseFloat(o[2])/v;for(var i=0;i<h;++i)b.push((i+1)*v);n()}}function i(e){f(e)}function a(){self.postMessage({type:"start"})}function u(e){self.postMessage({type:"progress",progress:e})}function c(){self.postMessage({type:"finish"})}function f(e){self.postMessage({type:"error",error:e.message})}var s,l,_,g,d,h,p,m,v,x={},b=[];self.addEventListener("message",function(r){switch(r=r.data,r.type){case"n_dims":d=r.n_dims;break;case"read":t(r.file);break;case"timestep":e(r.timestep_index)}})}function i(){var e="";return e+=r.toString(),e+=build_fortnd_worker.toString(),e+="build_fortnd_worker();",F(e)}function a(e){var r,t,n,o=e,a=i(),u=function(){},c={};return u.load_timestep=function(e,r){return c[e]=r,a.postMessage({type:"timestep",timestep_index:e}),u},u.on_finish=function(e){return arguments.length?("function"==typeof e&&(n=e),u):n},u.on_progress=function(e){return arguments.length?("function"==typeof e&&(t=e),u):t},u.on_start=function(e){return arguments.length?("function"==typeof e&&(r=e),u):r},u.read=function(e){return a.postMessage({type:"read",file:e}),u},a.addEventListener("message",function(e){switch(e=e.data,e.type){case"start":r&&r();break;case"progress":t&&t(e.progress);break;case"finish":n&&n();break;case"timestep":e.timestep_index in c&&c[e.timestep_index](e.data)}}),a.postMessage({type:"n_dims",n_dims:o}),u}function u(){return a(1)}function c(){return a(2)}function f(e){var r={};return{get:function(t){if(void 0!==r[t])return r[t];var n;switch(t){case"WEBGL_depth_texture":n=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":n=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":n=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":n=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;case"WEBGL_compressed_texture_etc1":n=e.getExtension("WEBGL_compressed_texture_etc1");break;default:n=e.getExtension(t)}return null===n&&console.warn("WebGL: "+t+" extension not supported."),r[t]=n,n}}}function s(e,r,t,n,o){var i=e.createShader(r);if(e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)===!1){var a=e.getShaderInfoLog(i);return o||(o=console.error),o("Unable to compile shader"),o(a),void e.deleteShader(i)}return e.getShaderParameter(i,e.COMPILE_STATUS)===!1&&(n||(n=console.warn),n(e.getShaderInfoLog(i),l(t))),i}function l(e){for(var r=e.split("\n"),t=0;t<r.length;t++)r[t]=t+1+": "+r[t];return r.join("\n")}function _(e,r,t,n,o){var i=e.createProgram(),a=s(e,e.VERTEX_SHADER,r,n,o),u=s(e,e.FRAGMENT_SHADER,t,n,o);if(i&&a&&u)return e.attachShader(i,a),e.attachShader(i,u),e.linkProgram(i),e.getProgramParameter(i,e.LINK_STATUS)===!1&&(o||(o=console.error),o(e.getProgramInfoLog(i))),e.deleteShader(a),e.deleteShader(u),i}function g(e){var r=e,t=_(r,d(),h()),n=d3.color("white"),o=d3.color("black"),i=.3,a=1;r.useProgram(t);var u=d3.map({vertex_normal:r.getAttribLocation(t,"vertex_normal"),vertex_position:r.getAttribLocation(t,"vertex_position")}),c=d3.map({face_color:r.getUniformLocation(t,"face_color"),projection_matrix:r.getUniformLocation(t,"projection_matrix"),wire_alpha:r.getUniformLocation(t,"wire_alpha"),wire_color:r.getUniformLocation(t,"wire_color"),wire_width:r.getUniformLocation(t,"wire_width")});return t.attribute=function(e){return u.get(e)},t.attributes=function(e){return arguments.length?(u.each(e),t):u.keys()},t.face_color=function(e){return arguments.length?(n=e,r.useProgram(t),r.uniform3fv(t.uniform("face_color"),[e.r/255,e.g/255,e.b/255]),t):n},t.set_projection=function(e){return r.useProgram(t),r.uniformMatrix4fv(t.uniform("projection_matrix"),!1,e),t},t.wire_alpha=function(e){return arguments.length?(i=e,r.useProgram(t),r.uniform1f(t.uniform("wire_alpha"),e),t):i},t.wire_color=function(e){return arguments.length?(o=e,r.useProgram(t),r.uniform3fv(t.uniform("wire_color"),[e.r/255,e.g/255,e.b/255]),t):o},t.wire_width=function(e){return arguments.length?(a=e,r.useProgram(t),r.uniform1f(t.uniform("wire_width"),e),t):a},t.uniform=function(e){return c.get(e)},t.uniforms=function(){return c.keys()},t.use=function(){return r.useProgram(t),t},t.face_color(t.face_color()).wire_alpha(t.wire_alpha()).wire_color(t.wire_color()).wire_width(t.wire_width())}function d(){return["attribute vec3 vertex_position;","attribute vec3 vertex_normal;","uniform mat4 projection_matrix;","varying vec3 _vertex_normal;","void main( void ) {","   gl_Position = projection_matrix * vec4( vertex_position, 1.0 );","   _vertex_normal = vertex_normal;","}"].join("\n")}function h(){return["#extension GL_OES_standard_derivatives : enable","precision highp float;","varying vec3 _vertex_normal;","uniform vec3 face_color;","uniform vec3 wire_color;","uniform float wire_alpha;","uniform float wire_width;","float edgeFactorTri() {","   vec3 d = fwidth( _vertex_normal.xyz );","   vec3 a3 = smoothstep( vec3( 0.0 ), d * wire_width, _vertex_normal.xyz );","   return min( min( a3.x, a3.y ), a3.z );","}","void main() {","   vec4 wire = mix( vec4(face_color, 1.0), vec4(wire_color, 1.0), wire_alpha);","   gl_FragColor = mix( wire, vec4(face_color, 1.0), edgeFactorTri() );","}"].join("\n")}function p(e,r,t,n){for(var o=e,i=_(o,m(r),v()),a=[],u=[],c=d3.color("black"),f=.3,s=1,t=t||0,n=n||1,l=0;l<r;++l)u.push(t+(n-t)*l/(r-1)),a.push(d3.color(d3.schemeCategory20c[l%r]));o.useProgram(i);var g=d3.map({vertex_normal:o.getAttribLocation(i,"vertex_normal"),vertex_position:o.getAttribLocation(i,"vertex_position"),vertex_value:o.getAttribLocation(i,"vertex_value")}),d=d3.map({gradient_colors:o.getUniformLocation(i,"gradient_colors"),gradient_stops:o.getUniformLocation(i,"gradient_stops"),projection_matrix:o.getUniformLocation(i,"projection_matrix"),wire_alpha:o.getUniformLocation(i,"wire_alpha"),wire_color:o.getUniformLocation(i,"wire_color"),wire_width:o.getUniformLocation(i,"wire_width")});return i.attribute=function(e){return g.get(e)},i.attributes=function(e){return arguments.length?(g.each(e),i):g.keys()},i.gradient_colors=function(e){if(!arguments.length)return a;a=e;var r=a.map(function(e){return[e.r/255,e.g/255,e.b/255]}).reduce(function(e,r){return e.concat(r)},[]);return o.useProgram(i),o.uniform3fv(i.uniform("gradient_colors"),r),i},i.gradient_stops=function(e){return arguments.length?(u=e,o.useProgram(i),o.uniform1fv(i.uniform("gradient_stops"),u),i):u},i.set_projection=function(e){return o.useProgram(i),o.uniformMatrix4fv(i.uniform("projection_matrix"),!1,e),i},i.wire_alpha=function(e){return arguments.length?(f=e,o.useProgram(i),o.uniform1f(i.uniform("wire_alpha"),e),i):f},i.wire_color=function(e){return arguments.length?(c=e,o.useProgram(i),o.uniform3fv(i.uniform("wire_color"),[e.r/255,e.g/255,e.b/255]),i):c},i.wire_width=function(e){return arguments.length?(s=e,o.useProgram(i),o.uniform1f(i.uniform("wire_width"),e),i):s},i.uniform=function(e){return d.get(e)},i.uniforms=function(){return d.keys()},i.use=function(){return o.useProgram(i),i},i.gradient_colors(i.gradient_colors()).gradient_stops(i.gradient_stops()).wire_alpha(i.wire_alpha()).wire_color(i.wire_color()).wire_width(i.wire_width())}function m(e){for(var r=["attribute vec2 vertex_position;","attribute vec3 vertex_normal;","attribute float vertex_value;","uniform mat4 projection_matrix;","uniform float gradient_stops["+e+"];","uniform vec3 gradient_colors["+e+"];","varying vec3 _vertex_normal;","varying vec3 _vertex_color;","void main() {","  gl_Position = projection_matrix * vec4( vertex_position, vertex_value, 1.0 );","  _vertex_normal = vertex_normal;","  _vertex_color = gradient_colors[0];","  float t;"],t=1;t<e;++t)r.push("  t = clamp((vertex_value - gradient_stops["+(t-1)+"]) / (gradient_stops["+t+"]-gradient_stops["+(t-1)+"]), 0.0, 1.0);"),r.push("  _vertex_color = mix( _vertex_color, gradient_colors["+t+"], t*t*(3.0-2.0*t));");return r.push("}"),r.join("\n")}function v(){return["#extension GL_OES_standard_derivatives : enable","precision mediump float;","varying vec3 _vertex_normal;","varying vec3 _vertex_color;","uniform vec3 wire_color;","uniform float wire_alpha;","uniform float wire_width;","float edgeFactorTri() {","   vec3 d = fwidth( _vertex_normal.xyz );","   vec3 a3 = smoothstep( vec3( 0.0 ), d * wire_width, _vertex_normal.xyz );","   return min( min( a3.x, a3.y ), a3.z );","}","void main() {","   vec4 wire = mix( vec4(_vertex_color, 1.0), vec4(wire_color, 1.0), wire_alpha);","   gl_FragColor = mix( wire, vec4(_vertex_color, 1.0), edgeFactorTri() );","}"].join("\n")}function x(){function e(){for(var e=0;e<16;++e)t[e]=n[e];return t}function r(){for(var e=0;e<16;++e)n[e]=t[e];return n}var t=new Float32Array(16).fill(0),n=new Float32Array(16);return t[0]=t[5]=t[10]=t[15]=1,t.identity=function(){return t.fill(0),t[0]=t[5]=t[10]=t[15]=1,t},t.ortho=function(e,r,n,o,i,a){return t[0]=2/(r-e),t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2/(o-n),t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=-1/(a-i),t[11]=0,t[12]=(r+e)/(e-r),t[13]=(o+n)/(n-o),t[14]=-i/(i-a),t[15]=1,t},t.scale=function(r,o,i){return n[0]=r*t[0],n[1]=r*t[1],n[2]=r*t[2],n[3]=r*t[3],n[4]=o*t[4],n[5]=o*t[5],n[6]=o*t[6],n[7]=o*t[7],n[8]=i*t[8],n[9]=i*t[9],n[10]=i*t[10],n[11]=i*t[11],n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],e(),t},t.translate=function(o,i,a){return r(),n[12]=t[0]*o+t[4]*i+t[8]*a+t[12],n[13]=t[1]*o+t[5]*i+t[9]*a+t[13],n[14]=t[2]*o+t[6]*i+t[10]*a+t[14],n[15]=t[3]*o+t[7]*i+t[11]*a+t[15],e()},t}function b(e,r){function t(){}function n(e){if(e==u){var r=g.get("vertex_value"),t=i.nodal_value(e);l.bindBuffer(l.ARRAY_BUFFER,r.buffer),l.bufferSubData(l.ARRAY_BUFFER,0,new Float32Array(t)),d.forEach(function(r){r(e)})}}function o(){if(!_){var e=new Float32Array(9*f);e.fill(0);for(var r=0;r<f;++r)e[9*r]=1,e[9*r+4]=1,e[9*r+8]=1;return e}console.error("You shouldn't be making vertex normals for indexed arrays")}var i,a,u,c,f,s,l=e,_=r||!1,g=d3.map(),d=[];return t.bind_buffer=function(e){var r=g.get(e);return l.bindBuffer(l.ARRAY_BUFFER,r.buffer),r},t.bind_element_array=function(){var e=g.get("element_array");return l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,e.buffer),t},t.bounding_box=function(){return c},t.elemental_value=function(e){return arguments.length?(a=e,t):(a=null,t)},t.indexed=function(){return _},t.mesh=function(e){if(!arguments.length)return i;i=e,c=i.bounding_box();var r=i.nodes(),o=i.elements();if(f=o.array.length/3,_){s=r.array.length/3;for(var a=new Float32Array(2*s/3),u=new Float32Array(s/3),d=new Uint32Array(f),h=0;h<f;++h){var p=o.array[h],m=r.map.get(p);a[m]=r.array[m],a[m+1]=r.array[m+1],u[m]=r.array[m+2],d[h]=m}var v=l.createBuffer();l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,v),l.bufferData(l.ELEMENT_ARRAY_BUFFER,d,l.STATIC_DRAW),g.set("element_array",{buffer:v})}else{s=3*f;for(var a=new Float32Array(6*f),u=new Float32Array(3*f),h=0;h<3*f;++h){var p=o.array[h],m=r.map.get(p);a[2*h]=r.array[3*m],a[2*h+1]=r.array[3*m+1],u[h]=r.array[3*m+2]}}var x=l.createBuffer();l.bindBuffer(l.ARRAY_BUFFER,x),l.bufferData(l.ARRAY_BUFFER,a,l.STATIC_DRAW);var b=l.createBuffer();return l.bindBuffer(l.ARRAY_BUFFER,b),l.bufferData(l.ARRAY_BUFFER,u,l.DYNAMIC_DRAW),g.set("vertex_position",{buffer:x,size:2,type:l.FLOAT,normalized:!1,stride:0,offset:0}),g.set("vertex_value",{buffer:b,size:1,type:l.FLOAT,normalize:!1,stride:0,offset:0}),i.subscribe(n),t},t.nodal_value=function(e){return arguments.length?(u=e,t):(u=null,t)},t.num_triangles=function(){return f},t.num_vertices=function(){return s},t.request_vertex_attribute=function(e){switch(e){case"vertex_normal":var r=o(),t=l.createBuffer();l.bindBuffer(l.ARRAY_BUFFER,t),l.bufferData(l.ARRAY_BUFFER,r,l.STATIC_DRAW),g.set("vertex_normal",{buffer:t,size:3,type:l.FLOAT,normalized:!1,stride:0,offset:0});break;case"vertex_position":case"vertex_value":break;default:console.warn(e+" attribute not supported")}},t.subscribe=function(e){return arguments.length?(d.push(e),t):(d=[],t)},t}function y(e){function r(e,i){return n=e,o=i,o.attributes(function(e,r){n.request_vertex_attribute(r)}),n.subscribe(t),r}function t(){a.forEach(function(e){e.apply(e,arguments)})}var n,o,i=e,a=[];return r.bounding_box=function(){return n?n.bounding_box():[[null,null,null],[null,null,null]]},r.geometry=function(){return n},r.render=function(){return n&&o&&(o.use(),o.attributes(function(e,r){var t=n.bind_buffer(r);i.vertexAttribPointer(e,t.size,t.type,t.normalized,t.stride,t.offset),i.enableVertexAttribArray(e)}),n.indexed()?(n.bind_element_array(),i.drawElements(i.TRIANGLES,3*n.num_triangles(),i.UNSIGNED_INT,0)):i.drawArrays(i.TRIANGLES,0,3*n.num_triangles())),r},r.shader=function(){return o},r.subscribe=function(e){return arguments.length?(a.push(e),r):(a=[],r)},r}function w(){function e(t){if(c=t,s=d3.select(c),!E(t))return void(_&&_("WebGL not supported"));var n={alpha:!1,antialias:!1,premultipliedAlpha:!1,stencil:!0};return null===(a=c.getContext("webgl",n)||c.getContext("experimental-webgl",n))?void(_&&_("Error creating WebGL context")):(l&&c.addEventListener("webglcontextlost",l,!1),u=f(a),u.get("ANGLE_instanced_arrays"),u.get("OES_element_index_uint"),u.get("OES_standard_derivatives"),e.clear_color(e.clear_color()),r(),s.call(v),e)}function r(){(n()||g)&&(g=!1,t()),requestAnimationFrame(r)}function t(){a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);for(var e=0;e<L.length;++e)L[e].render()}function n(){return(c.clientWidth!=d||c.clientHeight!=h)&&(d=c.clientWidth,h=c.clientHeight,c.width=d*m,c.height=h*m,a.viewport(0,0,d,h),o(),!0)}function o(e,r,t){if(!arguments.length){var n=d3.zoomTransform(c);return o(n.k,n.x,n.y)}w.ortho(0,d,h,0,-1e4,1e4).translate(r,t,0).scale(e,-e,1).translate(0,-h,0);for(var i=0;i<L.length;++i)L[i].shader().set_projection(w)}function i(){var r=d3.event.transform;o(r.k,r.x,r.y),e.render()}var a,u,c,s,l,_,g=!0,d=300,h=150,m=1,v=d3.zoom().on("zoom",i),w=x(),A=d3.color("#666666"),L=[];return e.add_mesh=function(r){var t=b(a).mesh(r),n=p(a,10,t.bounding_box()[0][2],t.bounding_box()[1][2]),i=y(a);return L.push(i(t,n)),o(),e.render()},e.add_view=function(r){return r.subscribe(e.render),L.push(r),o(),e.render()},e.clear_color=function(r){return arguments.length?(1==arguments.length&&(A=r),3==arguments.length&&(A=d3.rgb(arguments[0],arguments[1],arguments[2])),4==arguments.length&&(A=d3.rgb(arguments[0],arguments[1],arguments[2],arguments[3])),a&&A&&(a.clearColor(A.r/255,A.g/255,A.b/255,A.opacity),e.render()),e):A},e.gl_context=function(r){return arguments.length?(a=r,e):a},e.on_context_lost=function(r){return arguments.length?("function"==typeof r&&(l=r),e):l},e.on_error=function(r){return arguments.length?("function"==typeof r&&(_=r),e):_},e.render=function(){return g=!0,e},e.zoom_to=function(r){if(!arguments.length)return e;var t=r.bounding_box(),n=0,o=t[1][0]-t[0][0],i=t[1][1]-t[0][1],a=(t[0][0]+t[1][0])/2,u=h-(t[0][1]+t[1][1])/2,c=.9/Math.max(o/d,i/h),f=[d/2-c*a,h/2-c*u];2==arguments.length&&(n=arguments[1]),s.transition().duration(n).call(v.transform,d3.zoomIdentity.translate(f[0],f[1]).scale(c))},e}function E(e){return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}function A(){function e(){}var r,t={array:[],map:d3.map()},n={array:[],map:d3.map()},o=d3.map(),i=d3.map(),a=[];return e.bounding_box=function(){return r},e.elemental_value=function(e,r){if(1==arguments.length)return i.get(e);2==arguments.length&&i.set(e,r),a.has(e)&&a.get(e).forEach(function(e){e()})},e.elements=function(r){return arguments.length?(r.array&&r.map&&(n=r),e):n},e.element_array=function(r){return arguments.length?(n.array=r,e):n.array},e.element_index=function(e){return n.map.get(e)},e.element_map=function(r){return arguments.length?(n.map=r,e):n.map},e.nodal_value=function(r,t){return 1==arguments.length?o.get(r):(2==arguments.length&&o.set(r,t),a.forEach(function(e){e(r)}),e)},e.nodes=function(n){return arguments.length?(n.array&&n.map&&(t=n,r=L(t.array)),e):t},e.node_array=function(r){return arguments.length?(t.array=r,L(e.node_array()),e):t.array},e.node_index=function(e){return t.map.get(e)},e.node_map=function(r){return arguments.length?(t.map=r,e):t.map},e.num_elements=function(){return n.array.length/3},e.num_nodes=function(){return t.array.length/3},e.subscribe=function(e){a.push(e)},e}function L(e){for(var r=e.length/3,t=1/0,n=-(1/0),o=1/0,i=-(1/0),a=1/0,u=-(1/0),c=0;c<r;++c)e[3*c]<t?t=e[3*c]:e[3*c]>n&&(n=e[3*c]),e[3*c+1]<o?o=e[3*c+1]:e[3*c+1]>i&&(i=e[3*c+1]),e[3*c+2]<a?a=e[3*c+2]:e[3*c+2]>u&&(u=e[3*c+2]);return[[t,o,a],[n,i,u]]}function R(){function e(e){return e%i}function r(){return void 0===i||void 0===o?(console.error("Cache sizes not defined"),!1):void 0!==t&&void 0!==n||void 0!==a||(console.error("A getter must be defined if cache is not bounded by other caches"),!1)}var t,n,o,i,a,u,c,f,s,l=Object.create(null);return l.cache_left=function(e){return arguments.length?(t=e,l):t},l.cache_right=function(e){return arguments.length?(n=e,l):n},l.get=function(t){if(!r())return void console.error("Cache has not been properly initialized");if(t>=s&&t<s+i)return f[e(t)]?c[e(t)]:void console.error("Invalid data in buffer.");if(t<0||t>=o)return void console.error(t+" is outside allowable range");if(t!=s-1){if(t!=s+i)console.error("Jumps not yet supported. Coming soon...");else if(l.shift_right())return c[e(t)]}else if(l.shift_left())return c[e(t)]},l.getter=function(e){return arguments.length?("function"==typeof e?a=e:console.error("Getter must be a function"),l):a},l.is_full=function(){return c&&f.map(function(e){return e?1:0}).reduce(function(e,r){return e+r},0)==i},l.max_size=function(e){return arguments.length?(o=e,l):o},l.print=function(){console.log(c)},l.range=function(e){if(!arguments.length)return[s,s+i];if(!r())return void console.error("Cache not yet initialized. Set size and accessors before range");if(e[1]-e[0]!==i)return void console.error("Invalid range for cache of size "+i);s=e[0];for(var o=s;o<s+i;++o)t&&o>=t.range()[0]&&o<t.range()[1]?l.set(o,t.get(o)):n&&o>=n.range()[0]&&o<n.range()[1]?l.set(o,n.get(o)):a(o,l.set);return l},l.set=function(r,t){r>=s&&r<s+i?(c[e(r)]=u(e(r),t),f[e(r)]=!0):console.warn("Dataset "+r+" does not fall into the cache range")},l.size=function(e){return arguments.length?(i=e,c&&console.warn("Warning: Resizing cache, all data will be lost"),c=new Array(i),f=new Array(i).fill(!1),l):i},l.transform=function(e){return arguments.length?("function"==typeof e&&(u=e),l):u},l.shift_left=function(){var r,o=s-1;return!(o<0)&&((!t||void 0!==(r=t.take_right()))&&(n&&s+i-1<n.range()[0]&&n.shift_left(),s=o,f[e(s)]=!1,t?l.set(o,r):a(o,l.set),!0))},l.shift_right=function(){var r,u=s+i;return!(u>o)&&((!n||void 0!==(r=n.take_left()))&&(t&&s>=t.range()[1]&&t.shift_right(),s+=1,f[e(u)]=!1,n?l.set(u,r):a(u,l.set),!0))},l.take_left=function(){var r,t=s;return f[e(t)]&&(r=c[e(t)],l.shift_right()),r},l.take_right=function(){var r,t=s+i-1;return f[e(t)]&&(r=c[e(t)],l.shift_left()),r},l.valid=function(r){return f[e(r)]},u=function(e,r){return r},a=function(){console.error("A getter has not been defined for this cache.")},l}var F=function(e){var r=URL.createObjectURL(new Blob([e],{type:"application/javascript"})),t=new Worker(r);return URL.revokeObjectURL(r),t};e.fort14=o,e.fort63=u,e.fort64=c,e.gl_renderer=w,e.mesh=A,e.geometry=b,e.view=y,e.basic_shader=g,e.gradient_shader=p,e.cache=R,Object.defineProperty(e,"__esModule",{value:!0})});